openapi: 3.0.3
info:
  title: User APIs
  version: "1.0.0"

tags:
  - name: User
    description: Customer self-service routes (require authentication)

paths:
  /user/addresses:
    get:
      tags: [User]
      summary: Get my addresses
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Array of addresses for the authenticated user
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Address"
              example:
                - lnt: 35.503
                  alt: 33.02
                  address: "Kiryat Shmona, Israel"
                  logisticCenterId: "66e007000000000000000001"
        "401":
          description: Unauthorized
    post:
      tags: [User]
      summary: Add a new address (LC is pinned server-side for now)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/NewAddressInput"
            example:
              lnt: 35.503
              alt: 33.02
              address: "Kiryat Shmona, Israel"
      responses:
        "201":
          description: Updated addresses array after adding
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Address"
        "400":
          description: Validation error
        "401":
          description: Unauthorized
    delete:
      tags: [User]
      summary: Delete an address (match by lnt/alt/address)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [lnt, alt, address]
              properties:
                lnt:
                  type: number
                alt:
                  type: number
                address:
                  type: string
            example:
              lnt: 35.503
              alt: 33.02
              address: "Kiryat Shmona, Israel"
      responses:
        "200":
          description: Updated addresses array after deletion
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Address"
        "400":
          description: Validation error
        "401":
          description: Unauthorized
        "404":
          description: Address not found

  /user/name:
    get:
      tags: [User]
      summary: Get my name
      security:
        - bearerAuth: []
      responses:
        "200":
          description: User name
          content:
            application/json:
              schema:
                type: object
                required: [name]
                properties:
                  name:
                    type: string
              example:
                name: "Shirin Ishliyen"
        "401":
          description: Unauthorized

  /user/contact:
    get:
      tags: [User]
      summary: Get my contact info
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Contact info for the authenticated user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ContactInfo"
              example:
                name: "Shirin Ishliyen"
                email: "shirin@example.com"
                phone: "+972 50-123-4567"
                role: "customer"
        "401":
          description: Unauthorized
    patch:
      tags: [User]
      summary: Update my contact info (email and/or phone)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateContactInput"
            examples:
              updateEmail:
                value:
                  email: "new-email@example.com"
              updatePhone:
                value:
                  phone: "+972 52-765-4321"
              updateBoth:
                value:
                  email: "new-email@example.com"
                  phone: "+972 52-765-4321"
      responses:
        "200":
          description: Updated contact preview
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ContactUpdateResponse"
              example:
                name: "Shirin Ishliyen"
                email: "new-email@example.com"
                phone: "+972 52-765-4321"
                birthday: null
        "400":
          description: Validation error (bad email/phone or no fields provided)
        "401":
          description: Unauthorized
        "409":
          description: Email already in use

  /user/contact-info/{id}:
    get:
      tags: [User]
      summary: Get contact info by user id
      description: |
        If the requester is an admin/fManager/tManager, returns the specified user's contact info.
        Otherwise, returns the requester's own info (ignores the provided id).
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: MongoDB ObjectId of the target user
      responses:
        "200":
          description: Contact info
          content:
            application/json:
              schema:
                type: object
                required: [data]
                properties:
                  data:
                    $ref: "#/components/schemas/ContactInfo"
              example:
                data:
                  name: "Levy Cohen"
                  email: "levy@example.com"
                  phone: "+972 54-111-2222"
                  role: "farmer"
                  farmName: "Levy's Farm"
                  farmLogo: "https://cdn.example.com/logos/levy.png"
        "400":
          description: Bad request (invalid id)
        "401":
          description: Unauthorized
        "404":
          description: User not found

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Address:
      type: object
      required: [lnt, alt, address, logisticCenterId]
      properties:
        lnt:
          type: number
          description: Longitude
        alt:
          type: number
          description: Latitude
        address:
          type: string
        logisticCenterId:
          type: string
          description: Currently pinned to DEFAULT_LC_ID on the server
    NewAddressInput:
      type: object
      required: [lnt, alt, address]
      properties:
        lnt:
          type: number
        alt:
          type: number
        address:
          type: string
    UpdateContactInput:
      type: object
      properties:
        email:
          type: string
          format: email
        phone:
          type: string
          description: Allows +, digits, spaces, (), and dashes
      minProperties: 1
    ContactInfo:
      type: object
      required: [name, email, role]
      properties:
        name:
          type: string
        email:
          type: string
          format: email
        phone:
          type: string
          nullable: true
        role:
          type: string
          description: User role (e.g., customer, farmer, admin, fManager, tManager)
        farmName:
          type: string
          description: Present only for farmer role
        farmLogo:
          type: string
          description: Present only for farmer role
    ContactUpdateResponse:
      type: object
      required: [name, email]
      properties:
        name:
          type: string
        email:
          type: string
          format: email
        phone:
          type: string
          nullable: true
        birthday:
          type: string
          format: date-time
          nullable: true
