openapi: 3.0.3
info:
  title: DFCP Orders API
  version: 1.0.0
  description: Endpoints for creating customer orders and listing a user's recent orders.

tags:
  - name: Orders
    description: Customer order creation & retrieval (requires authentication)

paths:
  /orders:
    post:
      tags: [Orders]
      summary: Create a new order (customers only)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrderInput'
            example:
              amsId: "66efabcd0123456789abcdef"
              logisticsCenterId: "66e007000000000000000001"
              deliveryDate: "2025-09-29"
              deliveryAddress:
                lnt: 35.187
                alt: 32.085
                address: "Tel Aviv, Israel"
              items:
                - farmerOrderId: "66efaaaa0123456789aaaaaa"
                  itemId: "68960284330bf1699eee8955"
                  name: "Lettuce Romaine"
                  imageUrl: "https://example.com/romaine.jpg"
                  pricePerUnit: 7.5
                  quantity: 3.2
                  category: "Vegetables"
                  sourceFarmerName: "Levy Cohen"
                  sourceFarmName: "Green Valley"
                - farmerOrderId: "66efbbbb0123456789bbbbbb"
                  itemId: "6896056443caa05518908c20"
                  name: "Eggs Free Range (12 pack)"
                  imageUrl: ""
                  pricePerUnit: 18
                  quantity: 4
                  category: "Dairy"
                  sourceFarmerName: "Maya Klein"
                  sourceFarmName: "Sunny Farm"
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                type: object
                required: [data]
                properties:
                  data:
                    $ref: '#/components/schemas/Order'
              example:
                data:
                  _id: "66ef1f2e5d8f7a0012ab34cd"
                  customerId: "66ef1e7c5d8f7a0012ab3400"
                  deliveryAddress:
                    lnt: 35.187
                    alt: 32.085
                    address: "Tel Aviv, Israel"
                  deliveryDate: "2025-09-29T00:00:00.000Z"
                  LogisticsCenterId: "66e007000000000000000001"
                  amsId: "66efabcd0123456789abcdef"
                  items:
                    - itemId: "68960284330bf1699eee8955"
                      name: "Lettuce Romaine"
                      imageUrl: "https://example.com/romaine.jpg"
                      pricePerUnit: 7.5
                      quantity: 3.2
                      category: "Vegetables"
                      sourceFarmerName: "Levy Cohen"
                      sourceFarmName: "Green Valley"
                      farmerOrderId: "66efaaaa0123456789aaaaaa"
                  itemsSubtotal: 41.4
                  deliveryFee: 15
                  totalPrice: 56.4
                  totalOrderWeightKg: 7.2
                  status: "pending"
                  assignedDelivererId: null
                  customerDeliveryId: null
                  historyAuditTrail:
                    - userId: "66ef1e7c5d8f7a0012ab3400"
                      action: "ORDER_CREATED"
                      note: "Customer placed an order"
                      meta:
                        itemsCount: 2
                      timestamp: "2025-09-28T10:10:10.000Z"
                  createdAt: "2025-09-28T10:10:10.000Z"
                  updatedAt: "2025-09-28T10:10:10.000Z"
        '400':
          description: Validation error or insufficient stock
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                zod:
                  value:
                    error: "ValidationError"
                    details:
                      - path: ["items", 0, "quantity"]
                        message: "Required"
                stock:
                  value:
                    error: "BadRequest"
                    details: ["Not enough available quantity to reserve"]
        '401':
          description: Unauthorized
        '404':
          description: AMS not found or invalid farmerOrder mapping
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "NotFound"
                details: ["AvailableMarketStock not found"]
        '500':
          description: Server error

  /orders/my:
    get:
      tags: [Orders]
      summary: List my recent orders (latest first)
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: limit
          description: Max number of orders to return (capped at 15)
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 15
            default: 15
      responses:
        '200':
          description: List of recent orders for the authenticated user (up to 15)
          content:
            application/json:
              schema:
                type: object
                required: [data]
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Order'
              example:
                data:
                  - _id: "66ef1f2e5d8f7a0012ab34cd"
                    customerId: "66ef1e7c5d8f7a0012ab3400"
                    deliveryAddress:
                      lnt: 35.187
                      alt: 32.085
                      address: "Tel Aviv, Israel"
                    deliveryDate: "2025-09-29T00:00:00.000Z"
                    LogisticsCenterId: "66e007000000000000000001"
                    amsId: "66efabcd0123456789abcdef"
                    items:
                      - itemId: "68960284330bf1699eee8955"
                        name: "Lettuce Romaine"
                        imageUrl: "https://example.com/romaine.jpg"
                        pricePerUnit: 7.5
                        quantity: 3.2
                        category: "Vegetables"
                        sourceFarmerName: "Levy Cohen"
                        sourceFarmName: "Green Valley"
                        farmerOrderId: "66efaaaa0123456789aaaaaa"
                    itemsSubtotal: 41.4
                    deliveryFee: 15
                    totalPrice: 56.4
                    totalOrderWeightKg: 7.2
                    status: "pending"
                    assignedDelivererId: null
                    customerDeliveryId: null
                    historyAuditTrail: []
                    createdAt: "2025-09-28T10:10:10.000Z"
                    updatedAt: "2025-09-28T10:10:10.000Z"
        '401':
          description: Unauthorized
        '500':
          description: Server error

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    CreateOrderInput:
      type: object
      required: [amsId, logisticsCenterId, deliveryDate, deliveryAddress, items]
      properties:
        amsId:
          type: string
          description: ObjectId of the AvailableMarketStock document
        logisticsCenterId:
          type: string
          description: ObjectId of LogisticsCenter (stored as Order.LogisticsCenterId)
        deliveryDate:
          type: string
          format: date
        deliveryAddress:
          $ref: '#/components/schemas/Address'
        items:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/CreateOrderItem'

    CreateOrderItem:
      type: object
      required:
        [farmerOrderId, itemId, name, pricePerUnit, quantity, sourceFarmerName, sourceFarmName]
      properties:
        farmerOrderId:
          type: string
          description: ObjectId of the FarmerOrder to link
        itemId:
          type: string
          description: ID of the item (string, matches Item._id)
        name:
          type: string
        imageUrl:
          type: string
          default: ""
        pricePerUnit:
          type: number
          minimum: 0
        quantity:
          type: number
          minimum: 0.1
          description: Quantity in kg (or units per your system)
        category:
          type: string
          default: ""
        sourceFarmerName:
          type: string
        sourceFarmName:
          type: string

    Address:
      type: object
      required: [lnt, alt, address]
      properties:
        lnt:
          type: number
        alt:
          type: number
        address:
          type: string
        logisticCenterId:
          type: string
          nullable: true

    OrderItem:
      type: object
      required:
        [itemId, name, pricePerUnit, quantity, sourceFarmerName, sourceFarmName, farmerOrderId]
      properties:
        itemId:
          type: string
        name:
          type: string
        imageUrl:
          type: string
          default: ""
        pricePerUnit:
          type: number
          minimum: 0
        quantity:
          type: number
          minimum: 0.1
        category:
          type: string
          default: ""
        sourceFarmerName:
          type: string
        sourceFarmName:
          type: string
        farmerOrderId:
          type: string
          description: ObjectId string reference to FarmerOrder

    AuditEntry:
      type: object
      properties:
        userId:
          type: string
        action:
          type: string
        note:
          type: string
        meta:
          type: object
          nullable: true
          additionalProperties: true
        timestamp:
          type: string
          format: date-time

    Order:
      type: object
      required:
        [customerId, deliveryAddress, deliveryDate, LogisticsCenterId, amsId, items,
         itemsSubtotal, deliveryFee, totalPrice, totalOrderWeightKg, status]
      properties:
        _id:
          type: string
        customerId:
          type: string
        deliveryAddress:
          $ref: '#/components/schemas/Address'
        deliveryDate:
          type: string
          format: date-time
        LogisticsCenterId:
          type: string
          description: ObjectId of LogisticsCenter (note the capital L to match the model)
        amsId:
          type: string
          description: ObjectId of the AvailableMarketStock document
        items:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/OrderItem'
        itemsSubtotal:
          type: number
          minimum: 0
        deliveryFee:
          type: number
          minimum: 0
          default: 15
        totalPrice:
          type: number
          minimum: 0
        totalOrderWeightKg:
          type: number
          minimum: 0
        status:
          type: string
          enum:
            - pending
            - confirmed
            - farmer
            - in-transit
            - packing
            - "ready for pickUp"
            - out_for_delivery
            - delivered
            - canceled
            - problem
        assignedDelivererId:
          type: string
          nullable: true
        customerDeliveryId:
          type: string
          nullable: true
        historyAuditTrail:
          type: array
          items:
            $ref: '#/components/schemas/AuditEntry'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        details:
          type: array
          items:
            oneOf:
              - type: string
              - type: object
                additionalProperties: true
