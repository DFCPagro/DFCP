openapi: 3.0.0
info:
  title: Carts API
  version: "1.0.0"

paths:
  /carts/active:
    get:
      tags: [Carts]
      summary: Get the authenticated user's active cart for an AvailableMarketStock context
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: ams
          required: true
          description: AvailableMarketStock ID
          schema: { type: string }
      responses:
        '200':
          description: The active cart or null if none
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/Cart'
                  - type: "null"
              examples:
                none:
                  summary: No active cart
                  value: null
                some:
                  summary: A cart exists
                  value:
                    _id: "6711d5b34fd2bc001234abcd"
                    userId: "66f2aa000000000000000009"
                    LCid: "6711d5114fd2bc001234ab00"
                    availableMarketStockId: "6711d5304fd2bc001234ab77"
                    availableDate: "2025-09-18T00:00:00.000Z"
                    availableShift: "morning"
                    items:
                      - _id: "6711d5c44fd2bc001234abce"
                        availableMarketStockItemId: "6711d53a4fd2bc001234ab88"
                        itemId: "6711d5404fd2bc001234ab99"
                        displayName: "Tomatoes Cherry"
                        category: "vegetables"
                        imageUrl: null
                        pricePerUnit: 12.5
                        amountKg: 2
                        addedAt: "2025-09-18T07:10:00.000Z"
                        updatedAt: "2025-09-18T07:10:00.000Z"
                    status: "active"
                    lastActivityAt: "2025-09-18T07:10:00.000Z"
                    expiresAt: "2025-09-18T07:15:00.000Z"
        '401': { description: Unauthorized }

  /carts/{cartId}:
    get:
      tags: [Carts]
      summary: Get a single cart (must belong to the authenticated user)
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: cartId
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Cart
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cart'
        '400': { description: Invalid cartId }
        '401': { description: Unauthorized }
        '404': { description: Not found }

  /carts/add:
    post:
      tags: [Carts]
      summary: Add/merge a line in the active cart (creates cart if missing)
      description: >
        Atomically reserves (decrements) from AvailableMarketStock, then creates or updates the user's active cart
        for that LC+date+shift. If `inactivityMinutesOverride` is provided, it overrides the per-LC/default inactivity
        for this operation.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddItemInput'
            examples:
              add:
                value:
                  availableMarketStockId: "6711d5304fd2bc001234ab77"
                  amsItemId: "6711d53a4fd2bc001234ab88"
                  amountKg: 2.5
      responses:
        '200':
          description: Updated cart
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cart'
        '400': { description: Bad request (e.g., amount ≤ 0) }
        '401': { description: Unauthorized }
        '409': { description: Insufficient stock or item not active }

  /carts/{cartId}/items/{cartItemId}:
    patch:
      tags: [Carts]
      summary: Remove quantity from a cart line (omit amountKg to remove the whole line)
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: cartId
          required: true
          schema: { type: string }
        - in: path
          name: cartItemId
          required: true
          schema: { type: string }
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RemoveItemInput'
            examples:
              partial:
                value: { amountKg: 1.2 }
              full:
                value: {}
      responses:
        '200':
          description: Updated cart after removal
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cart'
        '400': { description: Invalid amount }
        '401': { description: Unauthorized }
        '404': { description: Cart or line not found }

  /carts/{cartId}/clear:
    post:
      tags: [Carts]
      summary: Clear entire cart (returns reserved stock and marks as "abandoned")
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: cartId
          required: true
          schema: { type: string }
      responses:
        '204': { description: Emptied }
        '401': { description: Unauthorized }
        '404': { description: Not found }

  /carts/{cartId}/checkout:
    post:
      tags: [Carts]
      summary: Checkout the cart (marks as "checkedout"; stock remains deducted)
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: cartId
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Checked-out cart
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cart'
        '401': { description: Unauthorized }
        '404': { description: Not found or not active }

  /carts/{cartId}/refresh-expiry:
    post:
      tags: [Carts]
      summary: Recompute cart expiry based on current AppConfig + global shift end
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: cartId
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Cart with refreshed expiresAt
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cart'
        '401': { description: Unauthorized }
        '404': { description: Not found or not active }

  /carts/{cartId}/abandon:
    post:
      tags: [Carts]
      summary: Abandon the cart (release stock and delete the cart)
      description: >
        User-scoped action. Releases all reserved quantities back to AvailableMarketStock,
        sets status to "abandoned", then deletes the cart document.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: cartId
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Result of abandon operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AbandonResult'
              examples:
                ok:
                  value: { deleted: true, cartId: "6711d5b34fd2bc001234abcd" }
        '401': { description: Unauthorized }
        '404': { description: Cart not found (or not owned by user) }

  /carts/{cartId}/expire:
    post:
      tags: [Carts, Admin]
      summary: Admin — force expire a cart (release stock and delete)
      description: >
        Admin-only. Releases reserved quantities to AvailableMarketStock,
        marks the cart as "expired", then deletes it. Optional reason field for auditing.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: cartId
          required: true
          schema: { type: string }
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExpireCartInput'
            examples:
              cutoff:
                value: { reason: "cutoff" }
      responses:
        '200':
          description: Result of forced expiration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExpireResult'
              examples:
                ok:
                  value: { deleted: true, cartId: "6711d5b34fd2bc001234abcd" }
        '401': { description: Unauthorized }
        '403': { description: Forbidden }
        '404': { description: Cart not found }

  /carts/{cartId}/reclaim:
    post:
      tags: [Carts, Admin]
      summary: Admin — reclaim inventory but keep cart document (mark as expired)
      description: >
        Admin-only. Returns reserved quantities to AvailableMarketStock and marks the cart as "expired",
        but does not delete the cart document.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: cartId
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Result of reclaim operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReclaimResult'
              examples:
                ok:
                  value: { reclaimed: true, cartId: "6711d5b34fd2bc001234abcd" }
        '401': { description: Unauthorized }
        '403': { description: Forbidden }
        '404': { description: Cart not found }

  /carts/wipe-shift:
    post:
      tags: [Carts, Admin]
      summary: Wipe all active carts for a service day + shift (does NOT return stock)
      description: >
        Admin operation. Empties items and marks carts as "expired" for the specified 00:00 UTC `availableDate` and `shiftName`.
        Optionally hard-deletes emptied carts.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WipeShiftInput'
            examples:
              wipe:
                value:
                  availableDate: "2025-09-18T00:00:00.000Z"
                  shiftName: "morning"
                  hardDelete: false
      responses:
        '204': { description: Wiped }
        '401': { description: Unauthorized }
        '403': { description: Forbidden }

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    ShiftName:
      type: string
      enum: [morning, afternoon, evening, night]

    CartItem:
      type: object
      required:
        - _id
        - availableMarketStockItemId
        - itemId
        - displayName
        - category
        - pricePerUnit
        - amountKg
        - addedAt
        - updatedAt
      properties:
        _id: { type: string }
        availableMarketStockItemId: { type: string }
        itemId: { type: string }
        displayName: { type: string }
        category: { type: string }
        imageUrl: { type: string, nullable: true }
        pricePerUnit: { type: number, minimum: 0 }
        amountKg: { type: number, minimum: 0 }
        addedAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    Cart:
      type: object
      required:
        - _id
        - userId
        - LCid
        - availableMarketStockId
        - availableDate
        - availableShift
        - items
        - status
        - lastActivityAt
        - expiresAt
      properties:
        _id: { type: string }
        userId: { type: string }
        LCid: { type: string, description: "LogisticsCenter _id" }
        availableMarketStockId: { type: string }
        availableDate: { type: string, format: date-time, description: "Normalized to 00:00 UTC" }
        availableShift:
          $ref: '#/components/schemas/ShiftName'
        items:
          type: array
          items:
            $ref: '#/components/schemas/CartItem'
        status:
          type: string
          enum: [active, abandoned, expired, checkedout]
        lastActivityAt: { type: string, format: date-time }
        expiresAt: { type: string, format: date-time }

    AddItemInput:
      type: object
      required: [availableMarketStockId, amsItemId, amountKg]
      properties:
        availableMarketStockId: { type: string }
        amsItemId: { type: string }
        amountKg: { type: number, minimum: 0.001, description: "kg reserved" }
        inactivityMinutesOverride:
          type: integer
          minimum: 1
          description: "Optional override for inactivity timeout in minutes"

    RemoveItemInput:
      type: object
      description: "If omitted, the entire line is removed."
      properties:
        amountKg: { type: number, minimum: 0.001 }

    WipeShiftInput:
      type: object
      required: [availableDate, shiftName]
      properties:
        availableDate:
          type: string
          format: date-time
          description: "Service day base at 00:00:00.000Z (UTC). Will be normalized to 00:00 UTC."
        shiftName:
          $ref: '#/components/schemas/ShiftName'
        hardDelete:
          type: boolean
          default: false

    ExpireCartInput:
      type: object
      properties:
        reason:
          type: string
          enum: [expired, cutoff, manual]
          default: manual

    AbandonResult:
      type: object
      required: [deleted, cartId]
      properties:
        deleted: { type: boolean }
        cartId: { type: string }

    ExpireResult:
      type: object
      required: [deleted, cartId]
      properties:
        deleted: { type: boolean }
        cartId: { type: string }

    ReclaimResult:
      type: object
      required: [reclaimed, cartId]
      properties:
        reclaimed: { type: boolean }
        cartId: { type: string }
