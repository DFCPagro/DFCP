openapi: 3.0.3
info:
  title: Available Market Stock APIs
  version: "1.1.0"

tags:
  - name: Market
    description: Market stock (shift-based) endpoints. Run `npm run seed:ams` to generate example docs.

paths:
  /market/available-stock/init:
    post:
      tags: [Market]
      summary: Create or fetch stock doc for LC + date + shift
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [LCid, date, shift]
              properties:
                LCid: { type: string, description: "Logistics Center id (ObjectId string)" }
                date: { type: string, format: date, description: "YYYY-MM-DD or ISO" }
                shift: { $ref: "#/components/schemas/ShiftName" }
            example:
              LCid: "66e007000000000000000001"
              date: "2025-10-07"
              shift: afternoon
      responses:
        "200":
          description: Stock document (existing or newly created)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AvailableMarketStock"
        "400": { description: LCid, date, and shift are required }
        "401": { description: Unauthorized }
        "500": { description: Server error }

  /market/available-stock:
    get:
      tags: [Market]
      summary: Get stock doc by LC + date + shift
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: LCid
          required: true
          schema: { type: string }
        - in: query
          name: date
          required: true
          schema: { type: string, format: date }
        - in: query
          name: shift
          required: true
          schema: { $ref: "#/components/schemas/ShiftName" }
      responses:
        "200":
          description: Stock document
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AvailableMarketStock"
        "400": { description: LCid, date, and shift are required }
        "401": { description: Unauthorized }
        "404": { description: Not found }
        "500": { description: Server error }

  /market/available-stock/{docId}:
    get:
      tags: [Market]
      summary: Get stock doc by its id
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: docId
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Stock document
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AvailableMarketStock"
        "400": { description: Invalid docId }
        "401": { description: Unauthorized }
        "404": { description: AvailableMarketStock not found }

  /market/available-stock/upcoming:
    get:
      tags: [Market]
      summary: List upcoming stock docs for LC (today forward)
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: LCid
          required: true
          schema: { type: string }
        - in: query
          name: count
          required: false
          schema: { type: integer, default: 6, minimum: 1, maximum: 50 }
        - in: query
          name: fromDate
          required: false
          schema: { type: string, format: date }
      responses:
        "200":
          description: Array of stock docs
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/AvailableMarketStock" }
        "400": { description: LCid is required }
        "401": { description: Unauthorized }
        "500": { description: Server error }

  /market/available-stock/next5:
    get:
      tags: [Market]
      summary: Next 5 shifts (by LC timezone) that actually have items
      description: Returns only shifts that already have a stock doc **with at least one item**, plus the delivery slot label.
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: LCid
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Array of upcoming shifts with stock
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/NextShiftWithStock" }
              example:
                - date: "2025-10-07"
                  shift: "afternoon"
                  docId: "6703f4f7c9b5f3a7b3a9d123"
                  deliverySlotLabel: "14:00–17:00"
                - date: "2025-10-07"
                  shift: "evening"
                  docId: "6703f527c9b5f3a7b3a9d124"
                  deliverySlotLabel: "18:00–21:00"
        "400": { description: LCid is required }
        "401": { description: Unauthorized }
        "500": { description: Server error }

  /market/available-stock/adjustQty:
    post:
      tags: [Market]
      summary: Atomically adjust line quantity by KG (reserve/release)
      description: |
        Negative `deltaKg` reserves (decrements). Positive releases (increments).
        If `enforceEnoughForReserve` is true (default), reserve succeeds only when there is enough quantity.
        If `autoSoldoutOnZero` is true (default), status is set to `soldout` when new quantity hits zero.
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AdjustQtyRequest"
            examples:
              reserve2kg:
                value:
                  docId: "6703f4f7c9b5f3a7b3a9d123"
                  lineId: "6703f4f7c9b5f3a7b3a9d555"
                  deltaKg: -2
                  enforceEnoughForReserve: true
                  autoSoldoutOnZero: true
              release1_5kg:
                value:
                  docId: "6703f4f7c9b5f3a7b3a9d123"
                  lineId: "6703f4f7c9b5f3a7b3a9d555"
                  deltaKg: 1.5
      responses:
        "200":
          description: Adjustment result with fresh line numbers
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AdjustQtyResponse"
              example:
                ok: true
                docId: "6703f4f7c9b5f3a7b3a9d123"
                lineId: "6703f4f7c9b5f3a7b3a9d555"
                newQty: 47.5
                unitsLeft: 38
        "400": { description: Invalid docId/lineId or bad body (deltaKg required and non-zero) }
        "401": { description: Unauthorized }
        "404": { description: Document or line not found after update }
        "409": { description: Not enough available quantity to reserve / conflict }

  /market/available-stock/adjustQtyUnits:
    post:
      tags: [Market]
      summary: Atomically adjust line quantity by UNITS (reserve/release)
      description: |
        Negative `unitsDelta` reserves (decrements). Positive releases (increments).
        Input units are **natural integers** and **bundle-aligned** internally.
        The service converts units → conservative KG, updates canonical KG, and re-calculates unit estimates.
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AdjustQtyUnitsRequest"
            examples:
              reserve24units_bundle12:
                value:
                  docId: "6703f4f7c9b5f3a7b3a9d123"
                  lineId: "6703f4f7c9b5f3a7b3a9d555"
                  unitsDelta: -24
                  enforceEnoughForReserve: true
                  autoSoldoutOnZero: true
              release1unit:
                value:
                  docId: "6703f4f7c9b5f3a7b3a9d123"
                  lineId: "6703f4f7c9b5f3a7b3a9d555"
                  unitsDelta: 1
      responses:
        "200":
          description: Adjustment result with fresh line numbers
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AdjustQtyResponse"
              example:
                ok: true
                docId: "6703f4f7c9b5f3a7b3a9d123"
                lineId: "6703f4f7c9b5f3a7b3a9d555"
                newQty: 46.2
                unitsLeft: 26
        "400": { description: Invalid docId/lineId or bad body (unitsDelta required and non-zero) }
        "401": { description: Unauthorized }
        "404": { description: Document or line not found after update }
        "409": { description: Not enough available quantity to reserve / conflict }

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    ShiftName:
      type: string
      enum: [morning, afternoon, evening, night]

    AvailableMarketStock:
      type: object
      required: [_id, LCid, availableDate, availableShift, items]
      properties:
        _id:
          type: string
          description: Stock document id (ObjectId)
        LCid:
          type: string
        availableDate:
          type: string
          format: date-time
          description: Midnight UTC of the availability date
        availableShift:
          $ref: "#/components/schemas/ShiftName"
        createdById:
          type: string
          nullable: true
        items:
          type: array
          items: { $ref: "#/components/schemas/AvailableStockItem" }

    AvailableStockItem:
      type: object
      description: >
        Line item inside a stock document. Supports kg-only and unit/mixed modes.
        Unit-math configuration is stored under `estimates`.
      required:
        - _id
        - itemId
        - displayName
        - category
        - originalCommittedQuantityKg
        - currentAvailableQuantityKg
        - farmerID
        - farmerName
        - farmName
        - status
      properties:
        _id: { type: string, description: "Line id (ObjectId)" }
        itemId: { type: string }
        displayName: { type: string }
        imageUrl: { type: string, nullable: true }
        category: { type: string }
        # Pricing (line-level). pricePerUnit may be derived from Item(avgWeightPerUnitGr) or override.
        pricePerKg:
          type: number
          description: "Base price per KG(from item.price.a)"
        pricePerUnit:
          type: number
          nullable: true
          description: "Per-unit price when unit/mixed; null otherwise (or when avg weight missing)"
        # Inventory
        originalCommittedQuantityKg: { type: number }
        currentAvailableQuantityKg: { type: number }
        status:
          type: string
          enum: [active, soldout, removed]
        # Relations
        farmerOrderId:
          type: string
          nullable: true
        farmerID: { type: string }
        farmerName: { type: string }
        farmName: { type: string }
        farmLogo:
          type: string
          nullable: true
        # Unit mode string straight from the model
        unitMode:
          type: string
          enum: [kg, unit, mixed]
        estimates:
          $ref: "#/components/schemas/Estimates"
      example:
        _id: "6703f4f7c9b5f3a7b3a9d555"
        itemId: "68960284330bf1699eee8955"
        displayName: "Lettuce Romaine"
        imageUrl: "https://cdn.example.com/items/lettuce.jpg"
        category: "vegetables"
        pricePerUnit: 6.5
        originalCommittedQuantityKg: 60
        currentAvailableQuantityKg: 47.5
        farmerOrderId: "6703f2e4c9b5f3a7b3a9d101"
        farmerID: "68960695a7850beaf8dac1ea"
        farmerName: "Yousef Haddad"
        farmName: "Haddad Fields"
        farmLogo: "https://cdn.example.com/logos/haddad.png"
        unitMode: mixed
        estimates:
          availableUnitsEstimate: 38
          avgWeightPerUnitKg: 0.5
          sdKg: 0.08
          unitBundleSize: 1
          zScore: 1.28
          shrinkagePct: 0.02

    Estimates:
      type: object
      description: Conservative availability metrics and tuning
      properties:
        availableUnitsEstimate:
          type: integer
          nullable: true
          description: Bundle-aligned natural integer, or null if not applicable
        avgWeightPerUnitKg:
          type: number
          nullable: true
        sdKg:
          type: number
          nullable: true
        unitBundleSize:
          type: integer
          minimum: 1
          description: Minimum sell/bundle increment (e.g., eggs=12)
        zScore:
          type: number
          description: Safety factor for conservative estimate
        shrinkagePct:
          type: number
          description: Handling loss factor for conservative estimate

    NextShiftWithStock:
      type: object
      required: [date, shift, docId, deliverySlotLabel]
      properties:
        date:
          type: string
          description: ISO date string (YYYY-MM-DD)
        shift:
          $ref: "#/components/schemas/ShiftName"
        docId:
          type: string
        deliverySlotLabel:
          type: string
          example: "14:00–17:00"

    AdjustQtyRequest:
      type: object
      required: [docId, lineId, deltaKg]
      properties:
        docId: { type: string }
        lineId: { type: string }
        deltaKg:
          type: number
          description: Negative to reserve, positive to release (non-zero)
        enforceEnoughForReserve:
          type: boolean
          default: true
        autoSoldoutOnZero:
          type: boolean
          default: true

    AdjustQtyUnitsRequest:
      type: object
      required: [docId, lineId, unitsDelta]
      properties:
        docId: { type: string }
        lineId: { type: string }
        unitsDelta:
          type: integer
          description: Negative to reserve, positive to release (non-zero). Natural integer; bundle alignment enforced.
        enforceEnoughForReserve:
          type: boolean
          default: true
        autoSoldoutOnZero:
          type: boolean
          default: true

    AdjustQtyResponse:
      type: object
      required: [ok, docId, lineId, newQty]
      properties:
        ok: { type: boolean }
        docId: { type: string }
        lineId: { type: string }
        newQty: { type: number }
        unitsLeft:
          type: integer
          nullable: true
          description: Estimate from `estimates.availableUnitsEstimate`, if present
        status:
          type: string
          enum: [soldout]
          description: Present when `autoSoldoutOnZero` triggers
